<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('資産登録 - 資産管理')}"></head>
<body>
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container" style="max-width:720px">
    <h2 class="mb-4">
        <i class="bi bi-pc-display me-2"></i>
        <span th:text="${asset.id != null} ? '資産編集' : '資産登録'">資産登録</span>
    </h2>

    <div class="card p-4">
        <form th:action="${asset.id != null}
                  ? @{/assets/{id}(id=${asset.id})}
                  : @{/assets}"
              th:object="${asset}" method="post" enctype="multipart/form-data">

            <div class="row g-3">
                <!-- 資産種別 -->
                <div class="col-md-6">
                    <label class="form-label">資産種別 <span class="text-danger">*</span></label>
                    <select class="form-select" th:field="*{assetType}" required>
                        <option value="">-- 選択 --</option>
                        <option th:each="t : ${assetTypes}"
                                th:value="${t}" th:text="${t.displayName}"></option>
                    </select>
                </div>

                <!-- 旧管理No -->
                <div class="col-md-6">
                    <label class="form-label">旧管理No <span class="badge bg-info ms-1">Excel時代</span></label>
                    <input type="text" class="form-control" th:field="*{oldManagementCode}"
                           placeholder="例: PC-0001">
                    <div class="form-text">Excel管理時代のコードがあれば入力</div>
                </div>

                <!-- QRコードID (自動発行 = 新管理No) -->
                <div class="col-md-6">
                    <label class="form-label">新管理No (QRコードID) <span class="badge bg-secondary ms-1">自動発行</span></label>
                    <input type="text" class="form-control" th:field="*{qrCodeId}"
                           th:readonly="${asset.id == null}" readonly
                           style="background-color: #e9ecef;">
                    <div class="form-text" th:if="${asset.id == null}">登録時に自動発行されます</div>
                </div>

                <!-- 品名 -->
                <div class="col-md-6">
                    <label class="form-label">品名 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" th:field="*{productName}"
                           required placeholder="例: ThinkPad X1 Carbon">
                </div>

                <!-- 型名 -->
                <div class="col-md-6">
                    <label class="form-label">型名</label>
                    <input type="text" class="form-control" th:field="*{modelName}"
                           placeholder="例: 20U9CTO1WW" id="modelNameInput">
                    <div id="shared-image-hint" class="form-text text-success d-none">
                        <i class="bi bi-image me-1"></i>同じ型名の画像が見つかりました（自動で適用されます）
                    </div>
                </div>

                <!-- 製造番号 -->
                <div class="col-md-6">
                    <label class="form-label">製造番号 (Serial)</label>
                    <input type="text" class="form-control" th:field="*{serialNumber}"
                           placeholder="例: PF-XXXXXX">
                </div>

                <!-- OS -->
                <div class="col-md-6">
                    <label class="form-label">OS</label>
                    <input type="text" class="form-control" th:field="*{os}"
                           placeholder="例: Windows 11 Pro">
                </div>

                <!-- CPU -->
                <div class="col-md-4">
                    <label class="form-label">CPU</label>
                    <input type="text" class="form-control" th:field="*{cpu}"
                           placeholder="例: Core i7-1365U">
                </div>

                <!-- メモリ -->
                <div class="col-md-4">
                    <label class="form-label">メモリ</label>
                    <input type="text" class="form-control" th:field="*{memory}"
                           placeholder="例: 16GB">
                </div>

                <!-- ストレージ -->
                <div class="col-md-4">
                    <label class="form-label">ストレージ</label>
                    <input type="text" class="form-control" th:field="*{storage}"
                           placeholder="例: 512GB SSD">
                </div>

                <!-- スペック (その他) -->
                <div class="col-12">
                    <label class="form-label">スペック (その他)</label>
                    <textarea class="form-control" th:field="*{spec}" rows="2"
                              placeholder="例: Wi-Fi 6E / Thunderbolt 4"></textarea>
                </div>

                <!-- 購入日 -->
                <div class="col-md-6">
                    <label class="form-label">購入日</label>
                    <input type="date" class="form-control" th:field="*{purchaseDate}">
                </div>

                <!-- ステータス -->
                <div class="col-md-6">
                    <label class="form-label">ステータス <span class="text-danger">*</span></label>
                    <select class="form-select" th:field="*{status}" required>
                        <option th:each="s : ${assetStatuses}"
                                th:value="${s}" th:text="${s.displayName}"></option>
                    </select>
                </div>

                <!-- 製品画像 -->
                <div class="col-12">
                    <label class="form-label">製品画像</label>
                    <input type="file" class="form-control" name="imageFile"
                           accept="image/*" id="imageFileInput">
                    <div class="form-text">
                        JPEG, PNG 等の画像ファイル (最大10MB)<br>
                        <small class="text-muted">未選択の場合、同じ型名の既存画像が自動で適用されます</small>
                    </div>
                    <!-- 既存画像 or 共有画像プレビュー -->
                    <div id="image-preview" class="mt-2"
                         th:classappend="${asset.imagePath == null} ? 'd-none' : ''">
                        <small id="image-preview-label" class="text-muted"
                               th:text="${asset.imagePath != null} ? '現在の画像:' : ''"></small>
                        <div class="mt-1">
                            <img id="image-preview-img"
                                 th:src="${asset.imagePath != null} ? @{'/uploads/' + ${asset.imagePath}} : ''"
                                 alt="製品画像" class="img-thumbnail" style="max-height:120px">
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>保存
                </button>
                <a href="/assets" class="btn btn-outline-secondary">キャンセル</a>
            </div>
        </form>
    </div>
</div>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script>
    (function() {
        const modelInput = document.getElementById('modelNameInput');
        const hint = document.getElementById('shared-image-hint');
        const preview = document.getElementById('image-preview');
        const previewLabel = document.getElementById('image-preview-label');
        const previewImg = document.getElementById('image-preview-img');
        const imageFileInput = document.getElementById('imageFileInput');
        let debounceTimer = null;
        let hasOwnImage = previewImg.getAttribute('src') !== '';

        modelInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(lookupSharedImage, 400);
        });

        imageFileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                hasOwnImage = true;
                hint.classList.add('d-none');
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewLabel.textContent = '選択した画像:';
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        function lookupSharedImage() {
            if (hasOwnImage) return;
            const modelName = modelInput.value.trim();
            if (!modelName) {
                hint.classList.add('d-none');
                preview.classList.add('d-none');
                return;
            }
            fetch('/assets/api/image-by-model?modelName=' + encodeURIComponent(modelName))
                .then(r => r.json())
                .then(data => {
                    if (data.imagePath) {
                        hint.classList.remove('d-none');
                        previewImg.src = '/uploads/' + data.imagePath;
                        previewLabel.textContent = '同じ型名の共有画像:';
                        preview.classList.remove('d-none');
                    } else {
                        hint.classList.add('d-none');
                        if (!hasOwnImage) {
                            preview.classList.add('d-none');
                        }
                    }
                })
                .catch(() => hint.classList.add('d-none'));
        }

        if (modelInput.value.trim() && !hasOwnImage) {
            lookupSharedImage();
        }
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('資産一覧 - 資産管理')}"></head>
<body>
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-pc-display me-2"></i>資産一覧</h2>
        <a href="/assets/new" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>新規登録
        </a>
    </div>

    <!-- 検索バー -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control"
                               placeholder="QRコードID / 品名 / 型名 / 製造番号で検索"
                               oninput="filterAssets()">
                    </div>
                </div>
                <div class="col-md-2">
                    <select id="filterStatus" class="form-select form-select-sm" onchange="filterAssets()">
                        <option value="">全ステータス</option>
                        <option value="在庫">在庫</option>
                        <option value="使用中">使用中</option>
                        <option value="故障">故障</option>
                        <option value="廃棄">廃棄</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="filterType" class="form-select form-select-sm" onchange="filterAssets()">
                        <option value="">全種別</option>
                        <option value="PC">PC</option>
                        <option value="携帯">携帯</option>
                    </select>
                </div>
                <div class="col-auto">
                    <span id="resultCount" class="text-muted small"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" id="assetTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px"></th>
                        <th>種別</th>
                        <th>QRコードID</th>
                        <th>品名</th>
                        <th>型名</th>
                        <th>製造番号</th>
                        <th>OS</th>
                        <th>CPU</th>
                        <th>メモリ</th>
                        <th>ストレージ</th>
                        <th>ステータス</th>
                        <th>現在の利用者</th>
                        <th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="asset : ${assets}" data-searchable="true"
                        th:attr="data-qr=${asset.qrCodeId},
                                 data-product=${asset.productName},
                                 data-model=${asset.modelName},
                                 data-serial=${asset.serialNumber},
                                 data-status=${asset.status.displayName},
                                 data-type=${asset.assetType.displayName}">
                        <td>
                            <img th:if="${asset.imagePath != null}"
                                 th:src="@{'/uploads/' + ${asset.imagePath}}"
                                 alt="" class="img-thumbnail" style="width:40px;height:40px;object-fit:cover">
                            <span th:if="${asset.imagePath == null}" class="text-muted"><i class="bi bi-image"></i></span>
                        </td>
                        <td>
                            <span th:text="${asset.assetType.displayName}"></span>
                        </td>
                        <td><code th:text="${asset.qrCodeId}"></code></td>
                        <td th:text="${asset.productName}"></td>
                        <td th:text="${asset.modelName}"></td>
                        <td><small th:text="${asset.serialNumber}"></small></td>
                        <td th:text="${asset.os}"></td>
                        <td><small th:text="${asset.cpu}"></small></td>
                        <td><small th:text="${asset.memory}"></small></td>
                        <td><small th:text="${asset.storage}"></small></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${asset.status.name() == 'STOCK'} ? 'badge-stock' :
                                                  (${asset.status.name() == 'IN_USE'} ? 'badge-inuse' :
                                                  (${asset.status.name() == 'BROKEN'} ? 'badge-broken' : 'badge-disposed'))"
                                  th:text="${asset.status.displayName}"></span>
                        </td>
                        <td>
                            <span th:if="${assignmentMap.containsKey(asset.id)}"
                                  th:text="${assignmentMap[asset.id].employee.name}"></span>
                            <span th:unless="${assignmentMap.containsKey(asset.id)}"
                                  class="text-muted">-</span>
                        </td>
                        <td class="text-center text-nowrap">
                            <!-- 詳細・QR -->
                            <a th:href="@{/assets/{id}(id=${asset.id})}"
                               class="btn btn-sm btn-outline-info me-1" title="詳細・QR">
                                <i class="bi bi-qr-code"></i>
                            </a>
                            <!-- コピー登録 -->
                            <a th:href="@{/assets/new(copyFrom=${asset.id})}"
                               class="btn btn-sm btn-outline-success me-1" title="コピー登録">
                                <i class="bi bi-copy"></i>
                            </a>
                            <!-- 編集 -->
                            <a th:href="@{/assets/{id}/edit(id=${asset.id})}"
                               class="btn btn-sm btn-outline-primary me-1" title="編集">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <!-- 削除 -->
                            <form th:action="@{/assets/{id}/delete(id=${asset.id})}"
                                  method="post" class="d-inline"
                                  onsubmit="return confirm('削除してよろしいですか？')">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="削除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(assets)}">
                        <td colspan="13" class="text-center text-muted py-4">資産が登録されていません</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script>
    function filterAssets() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
        const statusFilter = document.getElementById('filterStatus').value;
        const typeFilter = document.getElementById('filterType').value;
        const rows = document.querySelectorAll('#assetTable tbody tr[data-searchable]');
        let visibleCount = 0;

        rows.forEach(row => {
            const qrCode = (row.getAttribute('data-qr') || '').toLowerCase();
            const productName = (row.getAttribute('data-product') || '').toLowerCase();
            const modelName = (row.getAttribute('data-model') || '').toLowerCase();
            const serial = (row.getAttribute('data-serial') || '').toLowerCase();
            const status = row.getAttribute('data-status') || '';
            const assetType = row.getAttribute('data-type') || '';

            const matchesKeyword = !keyword ||
                qrCode.includes(keyword) ||
                productName.includes(keyword) ||
                modelName.includes(keyword) ||
                serial.includes(keyword);
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesType = !typeFilter || assetType === typeFilter;

            if (matchesKeyword && matchesStatus && matchesType) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('resultCount').textContent =
            keyword || statusFilter || typeFilter
                ? visibleCount + ' 件表示中'
                : '';
    }
</script>

</body>
</html>

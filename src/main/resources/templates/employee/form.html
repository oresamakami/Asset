<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('社員登録 - 資産管理')}"></head>
<body>
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container" style="max-width:640px">
    <h2 class="mb-4">
        <i class="bi bi-person-plus me-2"></i>
        <span th:text="${employee.id != null} ? '社員編集' : '社員登録'">社員登録</span>
    </h2>

    <div class="card p-4">
        <form th:action="${employee.id != null}
                  ? @{/employees/{id}(id=${employee.id})}
                  : @{/employees}"
              method="post">

            <div class="mb-3">
                <label class="form-label">社員番号 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="employeeCode"
                       th:value="${employee.employeeCode}"
                       required placeholder="例: EMP001">
            </div>
            <div class="mb-3">
                <label class="form-label">氏名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="name"
                       th:value="${employee.name}"
                       required placeholder="例: 山田太郎">
            </div>
            <div class="mb-3">
                <label class="form-label">部署</label>
                <select class="form-select" id="departmentId" name="departmentId"
                        onchange="loadSections(this.value)">
                    <option value="">-- 選択なし --</option>
                    <option th:each="dept : ${departments}"
                            th:value="${dept.id}"
                            th:text="${dept.name}"
                            th:selected="${employee.department != null and employee.department.id == dept.id}">
                    </option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">課</label>
                <select class="form-select" id="sectionId" name="sectionId">
                    <option value="">-- 選択なし --</option>
                    <option th:if="${sections != null}" th:each="sec : ${sections}"
                            th:value="${sec.id}"
                            th:text="${sec.name}"
                            th:selected="${employee.section != null and employee.section.id == sec.id}">
                    </option>
                </select>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>保存
                </button>
                <a href="/employees" class="btn btn-outline-secondary">キャンセル</a>
            </div>
        </form>
    </div>
</div>

<footer th:replace="~{fragments/layout :: footer}"></footer>

<script th:inline="javascript">
    const currentSectionId = /*[[${employee.section != null ? employee.section.id : null}]]*/ null;

    function loadSections(departmentId) {
        const sectionSelect = document.getElementById('sectionId');
        sectionSelect.innerHTML = '<option value="">-- 選択なし --</option>';

        if (!departmentId) return;

        fetch('/sections/api/by-department/' + departmentId)
            .then(res => res.json())
            .then(sections => {
                sections.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    if (s.id === currentSectionId) opt.selected = true;
                    sectionSelect.appendChild(opt);
                });
            });
    }
</script>
</body>
</html>
